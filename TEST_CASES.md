# LoneSword Browser AI Assistant - 测试用例文档

## 编译状态
✅ **BUILD SUCCEEDED** - 所有功能已成功编译

---

## 测试环境要求
- iOS 15.0+ (StoreKit 2 requirement)
- Xcode 14.0+
- iOS Simulator or Real Device
- 有效的 Qwen API Key（用于完整功能测试）
- App Store Connect 配置（用于 StoreKit 测试）

---

## 一、基础功能测试

### 1.1 设置页面打开/关闭
**测试目标**: 验证设置按钮和独立设置页面

**测试步骤**:
1. 启动 App
2. 点击 AI 洞察标题栏右侧的齿轮图标
3. 验证设置页面以 Sheet 形式从底部弹出
4. 在设置页面中配置 API Key 或查看订阅信息
5. 点击右上角"完成"按钮
6. 验证设置页面关闭，返回 AI 助手页面

**预期结果**:
- ✅ 设置页面以 Sheet 形式弹出（iOS 标准行为）
- ✅ 设置页面包含完整的导航栏和"完成"按钮
- ✅ 设置页面内容完整显示（API Key、订阅等级、使用说明）
- ✅ 点击"完成"后平滑关闭并返回 AI 助手
- ✅ 返回后 AI 助手页面状态保持不变

---

### 1.2 API Key 管理

#### 1.2.1 API Key 输入和保存
**测试步骤**:
1. 点击齿轮图标打开设置页面
2. 在 SecureField 中输入测试 API Key: `sk-test123456`
3. 点击"保存"按钮
4. 点击"完成"关闭设置页面
5. 关闭并重新打开 App
6. 再次打开设置页面

**预期结果**:
- ✅ API Key 输入框显示为密文（圆点）
- ✅ 输入框在竖屏时占满宽度，不会被压缩
- ✅ "测试"和"保存"按钮在输入框下方水平排列，等宽显示
- ✅ 点击保存后显示"✓ 已保存"
- ✅ 重启 App 后，API Key 已从 Keychain 加载（输入框填充）

#### 1.2.2 API Key 测试功能
**测试步骤**:
1. 输入**无效**的 API Key: `sk-invalid`
2. 点击"测试"按钮
3. 等待测试完成
4. 清空输入框，输入**有效**的 API Key
5. 点击"测试"按钮

**预期结果**:
- ✅ 测试按钮变为加载指示器
- ✅ 无效 Key 显示"✗ API Key无效"（红色）
- ✅ 有效 Key 显示"✓ API Key有效"（绿色）
- ✅ AI助手界面显示"私人API Key有效，无使用限制"
- ✅ 有效Key时跳过使用次数限制检查
- ✅ 测试期间按钮禁用

#### 1.2.3 私人API Key使用逻辑测试
**测试步骤**:
1. 配置有效的私人API Key
2. 在AI助手界面查看状态显示
3. 连续进行多次AI分析（超过免费版10次限制）
4. 测试用户对话功能
5. 配置无效的API Key
6. 再次测试AI功能

**预期结果**:
- ✅ 有效Key时显示"私人API Key有效，无使用限制"（绿色勾号）
- ✅ 有效Key时无使用次数限制，可无限次使用
- ✅ 无效Key时显示"私人API Key无效，请检查Key是否正确或是否还有用量"（橙色警告）
- ✅ 无效Key时API调用失败，显示用量不足提示
- ✅ 状态图标正确：有效时绿色勾号，无效时橙色警告

#### 1.2.4 Keychain 安全存储验证
**测试步骤**:
1. 保存 API Key 后，使用 Xcode 查看 App 的文件系统
2. 搜索 API Key 内容
3. 使用系统 Keychain Access（真机）验证

**预期结果**:
- ✅ API Key 不在任何明文文件中
- ✅ 只能通过 KeychainService 访问
- ✅ 删除 App 后，Keychain 数据清除

---

## 二、StoreKit 订阅功能测试

### 2.1 产品加载

**测试步骤**:
1. 在 App Store Connect 配置两个订阅产品:
   - `com.lonesword.subscription.basic` - ¥19.9/月
   - `com.lonesword.subscription.premium` - ¥39.9/月
2. 启动 App，点击齿轮图标打开设置页面
3. 滚动到订阅版本区域
4. 观察三个订阅等级卡片

**预期结果**:
- ✅ 免费版卡片显示"免费"、"每天10次AI分析"、"基础功能"
- ✅ 基础版卡片显示"¥19.9/月"、"10,000次AI分析/月"、"优先处理"、"邮件支持"、"购买"按钮
- ✅ 高级版卡片显示"¥39.9/月"、"100,000次AI分析/月"、"最高优先级"、"专属客服"、"高级功能"、"购买"按钮
- ✅ 免费版显示"当前套餐"标签（蓝色）
- ✅ 卡片有阴影效果，视觉层次清晰

### 2.2 购买流程（Sandbox 测试）

**前置条件**: 使用 Sandbox 测试账号

**测试步骤**:
1. 点击基础版的"购买"按钮
2. 完成 Sandbox 购买流程（无需真实付款）
3. 观察 UI 变化
4. 重启 App

**预期结果**:
- ✅ 弹出 Apple 支付界面（Sandbox）
- ✅ 购买成功后，基础版显示"已购买"标签（绿色）
- ✅ 基础版显示"当前套餐"标签
- ✅ 免费版不再显示"当前套餐"
- ✅ 重启后订阅状态保持

### 2.3 恢复购买

**测试步骤**:
1. 删除 App（不删除 Sandbox 账户）
2. 重新安装 App
3. 展开设置面板
4. 点击"恢复购买"按钮

**预期结果**:
- ✅ 显示加载状态
- ✅ 恢复成功后，之前购买的订阅显示"已购买"
- ✅ 显示"✓ 恢复成功"消息

### 2.4 订阅等级切换

**测试步骤**:
1. 当前为基础版订阅
2. 点击高级版的"购买"按钮
3. 完成升级

**预期结果**:
- ✅ 高级版显示"当前套餐"
- ✅ 基础版显示"已购买"（不再是"当前套餐"）
- ✅ 使用额度提升到 100,000次/月

---

## 三、AI 功能测试

### 3.1 URL变化立即触发状态更新

**测试步骤**:
1. 确保"识别AI生成"开关已开启
2. 打开任意网页
3. 点击页面内的链接跳转到新页面
4. 观察AI助手区域的状态变化
5. 测试锚点链接跳转（如：点击页面内的 #section 链接）
6. 使用前进/后退按钮导航
7. 在地址栏输入新URL

**预期结果**:
- ✅ 每次URL变化时立即显示"AI识别中…"
- ✅ 包括锚点链接跳转也触发状态更新
- ✅ 前进/后退按钮导航也触发状态更新
- ✅ 地址栏输入新URL也触发状态更新
- ✅ 页面加载完成后执行AI分析功能

### 3.2 自动翻译功能

**测试步骤**:
1. 确保"自动翻译"开关已勾选
2. 配置有效的 API Key
3. 在浏览器中打开英文网页: `https://www.example.com`
4. 等待页面加载完成
5. 观察 AI 总结区域

**预期结果**:
- ✅ AI 总结区域显示"AI识别中…"
- ✅ Qwen API 调用成功后，显示翻译后的中文内容
- ✅ 如果原文已是中文，返回原文

**调试验证**:
```swift
// 在 QwenService.swift 中添加日志
print("Translation request sent")
print("Detected language: \(result.detectedLanguage)")
print("Is translated: \(result.isTranslated)")
```

### 3.2 AI 生成检测功能

**测试步骤**:
1. 确保"识别AI生成"开关已勾选
2. 打开一篇可能由 AI 生成的文章
3. 等待 AI 分析完成

**预期结果**:
- ✅ 如果判断为 AI 生成，显示"**本文可能为AI创作**"（粗体）
- ✅ 如果判断为人类创作，不显示该提示

### 3.3 自动总结功能

**测试步骤**:
1. 确保"自动总结"开关已勾选
2. 打开一篇长文章（1000字以上）
3. 等待 AI 分析完成

**预期结果**:
- ✅ 显示"内容总结："后跟 200 字以内的结构化总结
- ✅ 总结内容准确概括文章要点
- ✅ 总结格式清晰（可能包含列表、要点）

### 3.4 功能开关组合测试

| 识别AI生成 | 自动翻译 | 自动总结 | 预期行为 |
|---------|---------|---------|---------|
| ✅ | ✅ | ✅ | 翻译 → AI检测 + 总结 |
| ✅ | ❌ | ✅ | AI检测 + 总结（原文） |
| ❌ | ✅ | ✅ | 翻译 → 总结（不检测AI） |
| ❌ | ❌ | ✅ | 仅总结（原文） |
| ❌ | ❌ | ❌ | 不触发任何AI分析 |

**测试步骤**:
1. 依次测试上述每种组合
2. 打开同一网页
3. 验证输出是否符合预期

---

## 四、对话功能测试

### 4.1 文本输入对话

**测试步骤**:
1. 在输入框输入问题: "这篇文章的核心观点是什么？"
2. 点击发送按钮（纸飞机图标）
3. 等待 AI 响应

**预期结果**:
- ✅ 对话区域显示"**用户:** 这篇文章的核心观点是什么？"
- ✅ 显示加载指示器
- ✅ AI 响应追加显示"**AI:** [回答内容]"
- ✅ 输入框自动清空
- ✅ 滚动视图自动滚动到底部

### 4.2 多轮对话

**测试步骤**:
1. 发送第一个问题: "总结一下主要内容"
2. 等待响应
3. 发送第二个问题: "有哪些实际应用场景？"
4. 等待响应

**预期结果**:
- ✅ 所有对话历史保留在对话区域
- ✅ 每次滚动到最新消息
- ✅ 用户和 AI 消息有明显视觉区分（**用户:** vs **AI:**）

### 4.3 语音输入测试

**前置条件**: 授予麦克风权限

**测试步骤**:
1. 点击麦克风图标
2. 系统弹出权限请求，点击"允许"
3. 麦克风图标变红，说话: "介绍一下这个网站"
4. 再次点击麦克风图标停止录音
5. 验证输入框内容
6. 点击发送

**预期结果**:
- ✅ 首次使用时请求麦克风权限
- ✅ 录音时麦克风图标变红
- ✅ 识别的文本自动填入输入框
- ✅ 停止录音后可编辑文本
- ✅ 发送后正常对话

**错误处理测试**:
- 拒绝权限: 显示错误提示
- 识别失败: 输入框保持空白

---

## 五、使用限制测试

### 5.1 免费版限制（每天10次）

**测试步骤**:
1. 确保当前为免费版
2. 连续触发 10 次 AI 分析（打开 10 个不同网页）
3. 打开第 11 个网页
4. 尝试发送对话

**预期结果**:
- ✅ 前 10 次正常工作
- ✅ 第 11 次显示"已达到使用次数限制，请升级订阅套餐"
- ✅ 对话输入也显示限制提示

### 5.2 每日重置测试

**测试步骤**:
1. 达到免费版每日限制
2. 修改系统时间到第二天（或等待真实的第二天）
3. 重启 App
4. 打开新网页

**预期结果**:
- ✅ 使用计数重置为 0
- ✅ 可以再次使用 10 次
- ✅ SwiftData 中 `lastResetDate` 更新为新日期

### 5.3 订阅后限制变更

**测试步骤**:
1. 免费版使用 10 次后达到限制
2. 购买基础版订阅
3. 立即尝试 AI 分析

**预期结果**:
- ✅ 限制立即解除
- ✅ 可以继续使用（10,000次/月）

---

## 六、UI 响应式测试

### 6.1 横屏/竖屏切换

**测试步骤**:
1. 竖屏模式下打开设置页面
2. 在 API Key 输入区域输入内容
3. 旋转到横屏
4. 验证布局
5. 旋转回竖屏

**预期结果**:
- ✅ 设置页面在旋转时自动适应宽度
- ✅ API Key 输入框在竖屏时占满宽度，不会被压缩
- ✅ "测试"和"保存"按钮在竖屏时水平排列，等宽显示
- ✅ 订阅卡片在不同屏幕尺寸下正确布局
- ✅ 输入框和按钮位置正确，无布局异常

### 6.2 iPad 多任务分屏

**测试步骤**:
1. 在 iPad 上启动 App
2. 进入分屏模式，调整 App 窗口大小
3. 展开设置面板

**预期结果**:
- ✅ 所有元素正确缩放
- ✅ 文本不被截断
- ✅ 按钮仍可点击

### 6.3 自动滚动测试

**测试步骤**:
1. 进行多轮对话（至少 5 轮）
2. 对话内容超出屏幕高度
3. 发送新消息

**预期结果**:
- ✅ 每次新消息后自动滚动到底部
- ✅ 滚动动画流畅
- ✅ 用户可手动滚动查看历史

---

## 七、错误处理测试

### 7.1 网络错误

**测试步骤**:
1. 关闭设备网络连接
2. 触发 AI 分析
3. 尝试测试 API Key
4. 尝试购买订阅

**预期结果**:
- ✅ AI 分析显示"[AI 错误] The Internet connection appears to be offline"
- ✅ API Key 测试显示"✗ API Key无效"
- ✅ StoreKit 显示网络错误提示

### 7.2 API Key 无效

**测试步骤**:
1. 配置无效的 API Key
2. 触发 AI 分析

**预期结果**:
- ✅ 显示"[AI 错误] HTTP error"
- ✅ 不消耗使用次数（错误时不计数）

### 7.3 空网页内容

**测试步骤**:
1. 打开一个完全空白的页面
2. 等待 AI 分析

**预期结果**:
- ✅ 显示"网页内容为空"
- ✅ 不调用 Qwen API
- ✅ 不消耗使用次数

### 7.4 Qwen API 响应格式错误

**测试步骤**:
1. 配置 API Key
2. 触发翻译功能
3. 如果 Qwen 返回非 JSON 格式

**预期结果**:
- ✅ Fallback 机制生效
- ✅ 返回原文内容
- ✅ 不崩溃

---

## 八、性能测试

### 8.1 大文本处理

**测试步骤**:
1. 打开包含 10,000+ 字的长文章
2. 触发 AI 分析

**预期结果**:
- ✅ 只发送前 6,000 字到 Qwen（避免超长请求）
- ✅ 响应时间 < 10 秒
- ✅ UI 不卡顿

### 8.2 快速切换页面

**测试步骤**:
1. 快速连续打开 5 个网页（每个间隔 1 秒）
2. 观察 AI 分析行为

**预期结果**:
- ✅ 只分析最后一个页面
- ✅ 前面的请求被正确取消
- ✅ 使用次数正确计数

### 8.3 内存测试

**测试步骤**:
1. 连续打开 20 个网页
2. 进行 20 轮对话
3. 使用 Xcode Instruments 监控内存

**预期结果**:
- ✅ 内存使用 < 200MB
- ✅ 无内存泄漏
- ✅ 对话历史过长时自动截断（保留最近 50 条）

---

## 九、数据持久化测试

### 9.1 SwiftData 持久化

**测试步骤**:
1. 使用 10 次免费额度
2. 购买基础版订阅
3. 完全关闭 App（从后台移除）
4. 重启 App

**预期结果**:
- ✅ 使用计数保留
- ✅ 订阅状态保留
- ✅ 最后重置日期正确

### 9.2 Keychain 持久化

**测试步骤**:
1. 保存 API Key
2. 删除 App
3. 重新安装 App（模拟器：删除后重新编译；真机：从 App Store 重新安装）

**预期结果**:
- ✅ 模拟器：Keychain 数据清除
- ✅ 真机：Keychain 数据保留（系统行为）

---

## 十、集成测试场景

### 场景 1: 首次使用完整流程

**测试步骤**:
1. 全新安装 App
2. 打开首页 `https://ai.quark.cn/`
3. 观察 AI 洞察区域（未配置 API Key）
4. 点击齿轮图标，展开设置
5. 输入并保存有效的 API Key
6. 关闭设置面板
7. 刷新页面（下拉）
8. 等待 AI 分析

**预期结果**:
- ✅ 首次显示"未配置API Key，请在设置中配置"
- ✅ 保存后刷新页面，AI 分析正常工作
- ✅ 显示总结和 AI 检测结果

### 场景 2: 订阅用户日常使用

**测试步骤**:
1. 已购买高级版订阅
2. 上午浏览 20 个网页
3. 与 AI 对话 15 轮
4. 下午再浏览 30 个网页
5. 晚上查看使用情况

**预期结果**:
- ✅ 所有操作正常，无限制提示
- ✅ 使用计数累加（但不影响使用）
- ✅ SwiftData 中 `totalUsageCount` 正确记录

### 场景 3: 免费用户升级流程

**测试步骤**:
1. 免费用户使用 8 次 AI 分析
2. 再使用 2 次，达到限制
3. 尝试第 11 次，被限制
4. 点击齿轮图标，购买基础版
5. 购买成功后，立即使用

**预期结果**:
- ✅ 达到限制时显示提示
- ✅ 购买后立即解除限制
- ✅ 订阅状态同步到 SwiftData
- ✅ 可继续使用

---

## 十一、边界条件测试

### 11.1 极端输入

| 测试项 | 输入 | 预期结果 |
|--------|------|---------|
| 空 API Key | 空字符串 | 保存按钮禁用 |
| 超长 API Key | 1000+ 字符 | 正常保存，Qwen 返回错误 |
| 特殊字符 | `!@#$%^&*()` | 正常保存，Qwen 返回错误 |
| 空对话输入 | 空字符串 | 发送按钮无反应 |
| 超长对话 | 10,000+ 字 | 正常发送，Qwen 截断 |

### 11.2 并发测试

**测试步骤**:
1. 同时点击"测试" API Key 和 "购买"订阅
2. 同时发送对话和打开新网页

**预期结果**:
- ✅ 各操作独立，不互相干扰
- ✅ 使用计数正确（原子操作）

---

## 十二、可访问性测试

### 12.1 VoiceOver 支持

**测试步骤**:
1. 开启 VoiceOver
2. 导航到设置面板
3. 尝试输入 API Key
4. 尝试购买订阅

**预期结果**:
- ✅ 所有按钮有正确的标签
- ✅ API Key 输入框读为"私人 Qwen API Key"
- ✅ 订阅卡片读出价格和功能

### 12.2 动态字体支持

**测试步骤**:
1. 系统设置中调整文字大小到最大
2. 打开 App

**预期结果**:
- ✅ 文字大小随系统设置变化
- ✅ 布局不破坏

---

## 测试清单总结

| 分类 | 测试项数量 | 优先级 | 状态 |
|------|-----------|--------|------|
| 基础功能 | 3 | P0 | ⏳ 待测试 |
| StoreKit | 4 | P0 | ⏳ 待测试 |
| AI 功能 | 4 | P0 | ⏳ 待测试 |
| 对话功能 | 3 | P1 | ⏳ 待测试 |
| 使用限制 | 3 | P0 | ⏳ 待测试 |
| UI 响应式 | 3 | P1 | ⏳ 待测试 |
| 错误处理 | 4 | P0 | ⏳ 待测试 |
| 性能测试 | 3 | P2 | ⏳ 待测试 |
| 数据持久化 | 2 | P0 | ⏳ 待测试 |
| 集成场景 | 3 | P1 | ⏳ 待测试 |
| 边界条件 | 2 | P2 | ⏳ 待测试 |
| 可访问性 | 2 | P2 | ⏳ 待测试 |

**总计**: 36 个主要测试项

---

## 已知限制和注意事项

1. **StoreKit 测试**: 需要在 App Store Connect 配置产品 ID，使用 Sandbox 账户测试
2. **Qwen API**: 需要真实有效的 API Key，测试前需申请
3. **语音识别**: 仅支持中文，需要真机测试（模拟器可能不支持麦克风）
4. **使用计数**: 每日重置基于本地时间，修改系统时间可测试
5. **内存测试**: 建议使用 Xcode Instruments 的 Leaks 和 Allocations 工具

---

## 测试环境配置

### App Store Connect 配置

1. 创建两个自动续期订阅产品:
   - 产品 ID: `com.lonesword.subscription.basic`
     - 价格: ¥19.9/月
     - 描述: 10,000次AI分析/月
   
   - 产品 ID: `com.lonesword.subscription.premium`
     - 价格: ¥39.9/月
     - 描述: 100,000次AI分析/月

2. 创建 Sandbox 测试账户

### Qwen API 配置

1. 访问 https://dashscope.aliyuncs.com/
2. 注册并创建 API Key
3. 在 App 设置中配置

---

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
测试环境: iOS [版本] / [设备型号]
App 版本: [版本号]

测试结果:
- 通过: XX 项
- 失败: XX 项
- 阻塞: XX 项

失败/阻塞问题:
1. [问题描述]
   - 重现步骤: ...
   - 预期结果: ...
   - 实际结果: ...
   - 严重程度: P0/P1/P2

备注: [其他发现和建议]
```

